CXXFLAGS = @CXXFLAGS@
TESTFLAGS = @TESTFLAGS@
prefix = @prefix@
LLVMCOV = @llvmcov@
datarootdir = @datarootdir@
datadir = @datadir@

VPATH = src:include
vpath %.cpp src
vpath %.hpp include

.PHONY: all clean install check-style coverage documentation test

all:

documentation:
	@doxygen .doxy.cfg

clean:
	@find . -name "*.test" -delete
	@find . -name "*.o" -delete
	@find . -name "*.gc??" -delete
	@find . -name "*.info" -delete
	@find . -name "*.profraw" -delete

love:
	@echo '<3'

friends:
	@echo '^-^'

check-style:
	@ cppcheck --enable=warning,performance,portability --platform=unix64 src/

test: clean reinforce.test
	@./reinforce.test
       
coverage: test
ifneq ($(CXX),g++)
	@echo "Only g++ is supported for coverage generation!"
	@exit 1
endif
	gcov -a -u -b -c src/*
	lcov -c --directory . -o reinforce.info
	lcov -e reinforce.info '$(CURDIR)/*' -o reinforce_filter.info
	lcov --summary reinforce_filter.info
	genhtml reinforce_filter.info --output-directory coverage
	gcovr -x -o coverage.xml -r .

%.o: %.cpp %.hpp
	$(CXX) -o $@ -c $< $(CXXFLAGS)

# Testing rules.
# These are always with -O0 to ensure that coverage data is correct.
src/%.o: %.cpp %.hpp
	$(CXX) -o $@ -c $< $(CXXFLAGS) $(TESTFLAGS)

test/%.o: test/%.cpp %.hpp
	$(CXX) -o $@ -c $< $(CXXFLAGS) $(TESTFLAGS)

reinforce.test: test/matrix.o src/matrix.o test/graph.o src/graph.o
	$(CXX) -o $@ $^ $(TESTFLAGS) -lcriterion
